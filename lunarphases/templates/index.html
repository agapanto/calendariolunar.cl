{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
  <!-- <h1>
    {{ title }}
  </h1> -->

  <div class="moon mx-auto my-4">
    <svg height="300" width="150" class="moon-left">
      <circle cx="150" cy="150" r="150" stroke="#45484B" fill="#45484B" class="bg"/>
      <circle cx="150" cy="150" r="150" stroke="#45484B" fill="#45484B" class="fg"/>
    </svg><svg height="300" width="150" class="moon-right">
      <circle cx="0" cy="150" r="150" stroke="#45484B" fill="#45484B" class="bg"/>
      <circle cx="0" cy="150" r="150" stroke="#45484B" fill="#45484B" class="fg"/>
    </svg>
  </div>

  <div class="text-center">
    <h1 class="logo">
      CALENDARIO<span class="moonlight">LUNAR</span>.CL
    </h1>
  </div>


  <div class="day-list mb-4">
    <ul>
      <li class="active">
        {{ lunar_phase.datetime | date }}
      </li>
    </ul>
  </div>

  <div class="text-center">
    <h3 class="title">
      {% trans 'Current Moon Phase' %}: {% trans lunar_phase.name %}
    </h3>
  </div>

  <hr class="dashed" />

  <div class="text-center pt-4 pb-4">
    <h3 class="title">
        <i class="fab fa-pagelines"></i> {% trans 'Crop tips' %}
    </h3>
    <p class="text-justify">
      <ul class="text-justify">
          {% for tip in tips %}
            <li class="text-justify mb-2">
              <span class="moonlight"><b>{{ tip.title }}:</b></span> {{ tip.message }}
            </li>
          {% endfor %}
      </ul>
    </p>
  </div>

  <hr class="dashed" />

{% endblock %}

{% block js %}
  {{ block.super }}
  <script
  			  src="https://code.jquery.com/jquery-3.3.1.min.js"
  			  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  			  crossorigin="anonymous">
  </script>
  <script>
  $(function(){
    var current_phase = {{ lunar_phase.moon_phase_day | safe }};
    var moon_size = calculateMoonSize(current_phase);
    var moon_colors = calculateMoonColors(current_phase);

    updateMoon(moon_size, moon_colors);
  });


  // Math.radians = function(degrees) {
  //   return degrees * Math.PI / 180;
  // };

  const max_phase = 27;
  const fullmoon_phase = 14;

  function calculateMoonSize(phase){
    var current_moon_size = $('.moon').width();
    var calculated_moonlight_size = 0;

    var moonlight_percentage =  100 * phase / fullmoon_phase;

    if (moonlight_percentage <= 100){
      calculated_moonlight_size = current_moon_size * moonlight_percentage / 100;
    }
    else{
      calculated_moonlight_size = current_moon_size * (moonlight_percentage - 100) / 100;
    }

    return calculated_moonlight_size;
  }

  function calculateMoonColors(phase){
    const moon_color = '#45484B';
    const moonlight_color = '#EEE6AB';

    var colors = {
      'moon': moon_color,
      'moonlight': moonlight_color
    };

    if (phase <= fullmoon_phase){
      colors.moon = moon_color;
      colors.moonlight = moonlight_color;
    }
    else{
      colors.moon = moonlight_color;
      colors.moonlight = moon_color;
    }

    return colors;
  }

  function updateMoonColors(colors){
    // moon-left
    $('.moon-left .bg').css({
      'stroke':colors.moon,
      'fill':colors.moon
    });
    $('.moon-left .fg').css({
      'stroke':colors.moonlight,
      'fill':colors.moonlight
    });
    // moon-right
    $('.moon-right .bg').css({
      'stroke':colors.moonlight,
      'fill':colors.moonlight
    });
    $('.moon-right .fg').css({
      'stroke':colors.moon,
      'fill':colors.moon
    });

  }

  function updateMoon(phase, colors){
    var current_moon_size = $('.moon').width();
    updateMoonColors(colors);

    var phaseScale = 1,
        phaseTrans = (current_moon_size/2),
        phaseRight = 0;

    if(phase <= (current_moon_size/2)) {
      phaseRight = (1-phase/(current_moon_size/2));
    }
    jQuery('.moon-right .fg').css({
      'transform':'scaleX(' + phaseRight + ')'
    });

    if(phase >= (current_moon_size/2)) {
      phaseScale = (1-(phase-(current_moon_size/2))/(current_moon_size/2));
      phaseTrans = (current_moon_size/2)*phaseScale;
    }
    jQuery('.moon-left .fg').css({
      'transform':'translate('+phaseTrans+'px,0) scaleX(' + (1-phaseScale) + ')'
    });
  }

  </script>
{% endblock %}
